#!/usr/bin/env python3

import glob
import sys
import numpy as np
from mpi4py import MPI
import numpy
import sys

def mpi_log_print(out, pre=0, msg='empty message', file= sys.stdout, flush=True):
    if out:
        print('\t'*pre + msg, file= file, flush=flush)
class merge_ascii:
    """
    """
    def __init__(self, fnm, lognm = '', exclude_sta = set() ):
        """
        fnm: Filename of the *.log generated by `wc -l *` that is described in README.
        exclude_sta: stations to be excluded.
        """
        self.comm = MPI.COMM_WORLD
        self.mpi_size = self.comm.Get_size()
        self.rank     = self.comm.Get_rank()
        self.mpi_log = open('%s_%03d.log' % (lognm, self.rank), 'w' )
        #
        self.fnm = fnm
        self.exclude_sta = exclude_sta
        #
        self.vol = dict()
        self.rd()
        self.prepare_mpi_job()

    def rd(self):
        """
        Read data and organize data.
        """
        mpi_log_print(True, 0, '# Input data from %s ...' % self.fnm, file=self.mpi_log, flush=True )
        mpi_log_print(True, 1, 'ignore stations: %s' % (', '.join(list(self.exclude_sta))) , file=self.mpi_log, flush=True )
        for line in open(self.fnm):
            n_sample, data_fnm = line.strip().split()
            n_sample = int(n_sample)
            sta, day, tmp = data_fnm.split('/')[-3:]
            if sta in self.exclude_sta:
                continue # get rid of excluded stations
            dat, com = tmp.split('.')
            if sta not in self.vol:
                self.vol[sta] = dict()
            if com not in self.vol[sta]:
                self.vol[sta][com] = dict()
            self.vol[sta][com][day] = {'size': n_sample, 'nm': dat}
            self.rootdir = '/'+'/'.join( open(self.fnm).readline().split()[1].split('/')[:-3] ) + '/'
    def get_path(self, com, sta, day):
        try:
            path = '/'.join( [self.rootdir, sta, day, self.vol[sta][com][day]['nm']] ) +'.'+com
            return path
        except:
            mpi_log_print(True, 0, 'Err: cannot find path for file %s %s %s' % (com, sta, day), file=sys.stderr, flush=True )
    def prepare_mpi_job(self):
        """
        """
        nsta = len( self.vol.keys() )
        chunk = int(np.ceil(nsta/self.mpi_size) )
        i_start, i_end = chunk*self.rank, chunk*(self.rank+1)
        if i_end > nsta:
            i_end = nsta
        sta_lst = sorted(list(self.vol.keys() ) )
        self.proc_sta = sta_lst[i_start: i_end]
        mpi_log_print(True, 0, '# Init mpi job. This node takes care of stations: [%d->%d) (%d/%d)' % (i_start, i_end, len(self.proc_sta ), nsta) , file=self.mpi_log, flush=False)
        mpi_log_print(True, 1, '%s' % ', '.join(self.proc_sta) , file=self.mpi_log, flush=True)
    def merge(self, out_prename, cut_head=1, cut_end=1):
        """
        Merge station by station
        cut_head, cut_end (1, 1) : how many days to remove when merging
        """
        mpi_log_print(True, 0, '# Merging, get rid of starting and end days (%d, %d)...' % (cut_head, cut_end), file=self.mpi_log, flush=True)
        nsta = len(self.proc_sta)
        for ista, sta in enumerate(self.proc_sta):
            for com in self.vol[sta]:
                outfnm = '%s/merged-%s-cut_%03d_%03d.%s' % (out_prename, sta, cut_head, cut_head, com)
                mpi_log_print(True, 1, '(%d/%d) %s %s ==> %s' % (ista+1, nsta, sta, com, outfnm), file=self.mpi_log, flush=True )
                day_lst = sorted(list(self.vol[sta][com].keys() ) )
                n_days = len(day_lst)
                fp = open(outfnm, 'w')
                for a_day in day_lst[cut_head: n_days-cut_end]:
                    path = self.get_path(com, sta, a_day)
                    mpi_log_print(True, 2, '%s' % path, file=self.mpi_log, flush=True )
                    vol_in = open(path, 'r').readlines()
                    print(''.join(vol_in), end='', file= fp)
                fp.close()

if __name__ == "__main__":
    WA_sta_exclude_set = set( (
        'WA11','WA12','WA28', 'WASA352', # different machine
        'WA26', 'WASA302' # warnings reported by 01_check.py
    ) )

    SA_sta_exclude_set = set( (
            'SA246', 'SA299', 'SA351', 'SA320-2', 'SA227', 'SA347', 'SA247', 
            'SA250', 'SA324-2', 'SA326S', 'SA277', 'SA344-2'
        ) )
    ######### WA
    app = merge_ascii('01_workspace/WA.log', '02_workspace/WA_merge_', WA_sta_exclude_set)
    app.merge('02_workspace/merged_data_WA/', 1, 1)
    ######### SA
    app = merge_ascii('01_workspace/SA.log', '02_workspace/SA_merge_', SA_sta_exclude_set)
    app.merge('02_workspace/merged_data_SA/', 1, 1)

    

